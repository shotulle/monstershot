<html>
    <head>
        <title>game</title>
        <style>
            canvas {
                border-style: dashed;
                border-width: 1px;
                border-color: blue;
            }
        </style>
    </head>

    <body>
            <canvas id="canvas" width="800" height="1000"></canvas>

            <script>
                var c = document.getElementById("canvas");
                var ctx = c.getContext("2d");   

                document.addEventListener("keydown", keyDownFunc);
                document.addEventListener("keyup", keyUpFunc);
                document.addEventListener("mousemove", mouseMove);
                document.addEventListener("mousedown", mouseDown);
                document.addEventListener("mouseup", mouseUp);

                var keyDown = {};
                var key = {
                    W: 87,
                    A: 65,
                    S: 83,
                    D: 68,
                    ENTER: 13,
                    SPACE: 32,
                    ONE   : 49,
                    TWO   : 50,
                    THREE : 51
                };

                var bullet = [];

                var WEAPON = {
                    NORMAL     : 1,
                    MACHINEGUN : 2,
                    SHOTGUN    : 3
                };

                var INTERVAL = {
                    NORMAL     : 15,
                    MACHINEGUN : 5,
                    SHOTGUN    : 60
                };

                var mouseX;
                var mouseY;
                var mouseIsDown = false;

                // var player = new Player();

                game = setInterval(loop, 1000 / 60);

                function keyDownFunc(e) {
                    keyDown[e.keyCode] = true;
                }

                function keyUpFunc(e) {
                    keyDown[e.keyCode] = false;
                }

                function mouseMove(e) {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }

                function mouseDown() {
                    mouseIsDown = true;
                }

                function mouseUp() {
                    mouseIsDown = false;
                }
                

                class Enemy {
                    constructor() {
                        this.x = Math.random() * 800;
                        this.y = Math.random() * 1000;
                        this.dx = 2;
                        this.dy = 2;
                        this.size = 25;
                        this.param = 0;
                        this.alive = true;
                        this.type = 0;
                        this.angle = 270;
                        this.sides = 14;
                        this.fire = [];
                        // this.count = 0;
                    }
                    
                    
                    move(playerx, playery) {
                        if (this.x > playerx && this.y > playery)
                        {
                            this.x -= this.dx;
                            this.y -= this.dy;
                        }
                        else if (this.x < playerx && this.y < playery)
                        {
                            this.x += this.dx;
                            this.y += this.dy;
                        }
                        else if (this.x > playerx && this.y < playery)
                        {
                            this.x -= this.dx;
                            this.y += this.dy;
                        }
                        else if (this.x < playerx && this.y > playery)
                        {
                            this.x += this.dx;
                            this.y -= this.dy;
                        }
                    }

                    draw() {
                        var dent = this.size * 0.5;
                        var radOffset = this.angle * Math.PI/180;
                        var radDiv = (Math.PI*2)/this.sides/2;
                        
                        if (this.alive == true)
                        {
                            ctx.beginPath();
                            ctx.moveTo(this.x + Math.cos(radOffset) * this.size, this.y + Math.sin(radOffset) * this.size);
                            for (var i = 1; i < this.sides * 2; i++) {
                                var rad = radDiv * i + radOffset;
                                var len = (i % 2) ? dent : this.size;
                                ctx.lineTo(
                                    this.x + Math.cos(rad)*len,
                                    this.y + Math.sin(rad)*len
                                );
                                ctx.fillStyle = 'rgb(7, 111, 0)';
                                ctx.fill();
                            }
                        }
                    }

                    kill() {
                        this.alive = false;
                        
                    }
                }

                
                function gameClear() {
                    clearInterval(game)
                    for (var i = 0; i < 6; i++)
                    {
                        ctx.font = "120" - (i*5) + "px serif";
                        ctx.fillStyle = 'rgb(' + Math.floor(Math.random()*255) + ',' + Math.floor(Math.random()*255) + ', 255)';
                        ctx.fillText("GAME CLEAR", 35 + (i * 10), 500 + (i * 5));
                    }

                    ctx.beginPath();
                    ctx.arc(player.x + player.eyeX - 10, player.y + player.eyeY, player.size / 5, 0, Math.PI*2, true);
                    ctx.fillStyle = 'white';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(player.x + player.eyeX + 10, player.y + player.eyeY, player.size / 5, 0, Math.PI*2, true);
                    ctx.fillStyle = 'white';
                    ctx.fill();

                    ctx.beginPath();
                    ctx.arc(player.x + player.eyeX - 10, player.y + player.eyeY, player.size / 5, 0, Math.PI, true);
                    ctx.strokeStyle = 'rgb(223, 153, 179)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(player.x + player.eyeX + 10, player.y + player.eyeY, player.size / 5, 0, Math.PI, true);
                    ctx.strokeStyle = 'rgb(223, 153, 179)';
                    ctx.stroke();

                    ctx.font = "28px serif";
                    ctx.fillStyle = "rgb(253, 146, 253)";
                    ctx.fillText('â™ª', player.x + 25, player.y - 20);

                }

                var number_of_enemies = 2;
                var enemies = [];
                for (var i = 0; i < number_of_enemies; i++)
                {
                    enemies.push(new Enemy());
                }


                class Player {
                    constructor() {
                        this.size = 25;
                        this.x = 50;
                        this.y = 50;
                        this.speed = 7;
                        this.dx = 0; 
                        this.dy = 0;           
                        this.acceleration = 0.5; 
                        this.friction = 0.92;    
                        this.radian = 0;          
                        this.eyeSize = this.size / 5;
                        this.eyeX = 0;           
                        this.eyeY = 0;
                        this.weapon = WEAPON.NORMAL;
                        this.reloadNormal = 0;
                        this.reloadMachinegun = 0;
                        this.reloadShotgun = 0;
                        this.alive = true;
                    }

                    reload() {
                    if (this.reloadNormal > 0)
                        this.reloadNormal--;
                    if (this.reloadMachinegun > 0)
                        this.reloadMachinegun--;
                    if (this.reloadShotgun > 0)
                        this.reloadShotgun--;
                    }

                    vector() {
                        if (keyDown[key.W])  this.dy -= this.acceleration;
                        if (keyDown[key.A])  this.dx -= this.acceleration;
                        if (keyDown[key.S])  this.dy += this.acceleration;
                        if (keyDown[key.D])  this.dx += this.acceleration;
                        
                        this.dx = this.dx * this.friction;
                        this.dy = this.dy * this.friction;
                    }

                    weaponChange() {
                        if (keyDown[key.ONE]) this.weapon = WEAPON.NORMAL;
                        if (keyDown[key.TWO]) this.weapon = WEAPON.MACHINEGUN;
                        if (keyDown[key.THREE]) this.weapon = WEAPON.SHOTGUN;
                    }

                    playerRadian() {
                        var dx = mouseX - this.x;
                        var dy = mouseY - this.y;
                        this.radian = Math.atan2(dy,dx);
                    }

                    move() {
                        this.x += this.dx;
                        this.y += this.dy;
                        
                        this.eyeX = 0.45 * this.size*Math.cos(this.radian);
                        this.eyeY = 0.45 * this.size*Math.sin(this.radian);
                    }

                    draw() {
                        if (this.alive)
                        {
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2, true);
                            ctx.fillStyle = 'white';
                            ctx.fill();

                            ctx.beginPath();
                            ctx.arc(this.x + this.eyeX - 10, this.y + this.eyeY, this.size / 5, 0, Math.PI*2, true);
                            ctx.fillStyle = 'rgb(223, 153, 179)';
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(this.x + this.eyeX + 10, this.y + this.eyeY, this.size / 5, 0, Math.PI*2, true);
                            ctx.fillStyle = 'rgb(223, 153, 179)';
                            ctx.fill();
                        }
                        else if (this.alive == false)
                        {
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2, true);
                            ctx.fillStyle = 'white';
                            ctx.fill();

                            ctx.beginPath();
                            ctx.moveTo(this.x + this.eyeX - 10, this.y + this.eyeY + 3);
                            ctx.lineTo(this.x + this.eyeX - 10, this.y + this.eyeY + 17);
                            ctx.strokeStyle = 'rgb(109, 222, 249)'
                            ctx.lineWidth = 7;
                            ctx.stroke();

                            ctx.beginPath();
                            ctx.moveTo(this.x + this.eyeX + 10, this.y + this.eyeY + 3);
                            ctx.lineTo(this.x + this.eyeX + 10, this.y + this.eyeY + 17);
                            ctx.strokeStyle = 'rgb(109, 222, 249)'
                            ctx.stroke();

                            ctx.beginPath();
                            ctx.moveTo(this.x + this.eyeX - 15, this.y + this.eyeY - 5);
                            ctx.lineTo(this.x + this.eyeX - 5, this.y + this.eyeY + 5);
                            ctx.moveTo(this.x + this.eyeX - 5, this.y + this.eyeY - 5);
                            ctx.lineTo(this.x + this.eyeX - 15, this.y + this.eyeY + 5);
                            ctx.lineWidth = 4;
                            ctx.strokeStyle = 'rgb(223, 153, 179)';
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.moveTo(this.x + this.eyeX + 5, this.y + this.eyeY - 5);
                            ctx.lineTo(this.x + this.eyeX + 15, this.y + this.eyeY + 5);
                            ctx.moveTo(this.x + this.eyeX + 15, this.y + this.eyeY - 5);
                            ctx.lineTo(this.x + this.eyeX + 5, this.y + this.eyeY + 5);
                            ctx.strokeStyle = 'rgb(223, 153, 179)';
                            ctx.stroke();
                        
                        }
        
                    }

                    touchEnemy() {
                        this.alive = false;
                        clearInterval(game);
                    }

                    gameOver() {
                        for (var i = 0; i < 6; i++)
                        {
                            ctx.font = "120" - (i*5) + "px serif";
                            ctx.fillStyle = 'rgb(' + Math.floor(Math.random()*255) + ',' + Math.floor(Math.random()*255) + ', 0)';
                            ctx.fillText("GAME OVER", 75 + (i * 10), 500 + (i * 5));
                        }
                    }
                }

                var player = new Player();


                function shot() {
                    switch (player.weapon) {
                    case WEAPON.NORMAL:
                        if (player.reloadNormal === 0) {
                            bullet.push( new Bullet(5, player.x, player.y, player.radian, 3, 400) );
                            player.reloadNormal = INTERVAL.NORMAL;
                        }
                        break;
                    case WEAPON.MACHINEGUN:
                        if (player.reloadMachinegun === 0) {
                            bullet.push( new Bullet(5, player.x, player.y, player.radian, 7, 200) );
                            player.reloadMachinegun = INTERVAL.MACHINEGUN;
                        }
                        break;
                    case WEAPON.SHOTGUN:
                        if (player.reloadShotgun === 0) {
                            for (var i = -5; i <= 5; i++) {
                                var rad = i * Math.PI / 35;
                                bullet.push( new Bullet(3, player.x, player.y, player.radian + rad, 5, 100) );
                            }
                            player.reloadShotgun = INTERVAL.SHOTGUN;
                        }
                        break;
                    }  
                }

                

                function calcBulletLimit() {
                    for (var i = 0; i < bullet.length; i++) {
                        if ( bullet[i].limit > 0 ) {
                            bullet[i].limit--;
                        } else {
                            bullet.splice(i, 1);
                            i--;
                        }
                    }
                }

              

                function bulletMove() {
                    for (var i = 0; i < bullet.length; i++) {
                        bullet[i].x += bullet[i].speed * Math.cos(bullet[i].radian);
                        bullet[i].y += bullet[i].speed * Math.sin(bullet[i].radian);
                    }
                }

                function bulletDraw() {
                    for (var i = 0; i < bullet.length; i++) {
                        ctx.beginPath();
                        ctx.arc(bullet[i].x, bullet[i].y, bullet[i].size, 0, Math.PI*2, true);
                        ctx.fillStyle = 'rgb(250, 254, 121)';
                        ctx.fill();
                    }
                }

                function loop() {
                    if (enemies.every( (e) => !(e.alive) )) {
                        gameClear();
                        setInterval(gameClear, 300);
                    }

                    for (var i = 0; i < bullet.length; i++)
                    {
                        for (var j = 0; j < enemies.length; j++)
                        {
                            if(Math.abs(enemies[j].x - bullet[i].x) < 20 && Math.abs(enemies[j].y - bullet[i].y) < 20)
                            {
                                enemies[j].kill();
                            }
                        }
                    }
                    if (keyDown[key.SPACE]) {
                        enemies[Math.floor(Math.random()*enemies.length)].kill();
                    }   
                    if (keyDown[key.ENTER]) {
                        for (i = 0; i < enemies.length; i++)
                        {
                            if(!enemies[i].alive) {
                                enemies[i].alive = true;
                            }
                        }
                    }             
                    player.vector();
                    player.playerRadian();
                    

                    for (var i = 0; i < enemies.length; i++)
                    {
                        if (!enemies[i].alive) {
                            continue;
                        }
                        if (Math.abs(enemies[i].x - player.x) < 45 && Math.abs(enemies[i].y - player.y) < 45)
                        {
                            player.touchEnemy();
                            setInterval(player.gameOver, 300);
                        }
                    }

                
                    player.reload();
                    player.weaponChange();
                
                    if (mouseIsDown)
		            shot();

                    player.move();
                    bulletMove();

                    for (var i = 0; i < enemies.length; i++) {
                        // enemyMove(enemies[i]);
                        enemies[i].move(player.x, player.y);
                    }

                    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    player.draw();
                    bulletDraw();

                    for (var i = 0; i < enemies.length; i++) {
                        enemies[i].draw();
                    }
                }

            

            function Bullet(size,x,y,radian,speed,distance) {
                this.size = size;
                this.x = x;
                this.y = y;
                this.radian = radian;
                this.speed = speed;               
                this.limit = Math.round(distance/speed);
            }

           
            </script>
    </body>

</html>